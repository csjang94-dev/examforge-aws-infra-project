name: ğŸš€ Deploy Frontend to S3

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Select the branch to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prd
      
      # ìˆ˜ë™ ì‹¤í–‰ ì‹œ í™˜ê²½ ì„ íƒì„ ê°•ì œí•˜ì—¬ ë¡¤ ë¶„ê¸°ë¥¼ ëª…í™•í•˜ê²Œ í•¨
      target_environment:
        description: 'Select deployment target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development # Dev í™˜ê²½
          - production # Prod í™˜ê²½
          
  push:
    branches:
      - main
    paths:
      - 'frontend/**'

env:
  # ëª¨ë“  í™˜ê²½ì—ì„œ ë™ì¼í•œ ë¦¬ì „ ì‚¬ìš©
  AWS_REGION: ap-northeast-2
  # ê¸°ë³¸ S3 ë²„í‚· (Devìš© ë˜ëŠ” Fallbackìš©) - ì´ ê°’ì€ ì•„ë˜ Jobì—ì„œ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.
  S3_BUCKET_DEV: aws-quiz-static-content-ap-northeast-2-140023399909
  S3_BUCKET_PRD: aws-quiz-static-content-ap-northeast-2-PROD-BUCKET # ğŸ¯ Prod ë²„í‚· ì´ë¦„ìœ¼ë¡œ ë³€ê²½ í•„ìš”

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
    
    # ğŸŒŸ ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì‚¬ìš©ìê°€ ì„ íƒí•œ í™˜ê²½ì„ ì‚¬ìš©í•˜ë©°, Prod í™˜ê²½ì— ìŠ¹ì¸ ê·œì¹™ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    environment: ${{ github.event_name == 'push' && 'development' || github.event.inputs.target_environment }}

    steps:
      
      # 1. âš™ï¸ í™˜ê²½ ë³€ìˆ˜ ë° ë¸Œëœì¹˜ ê²°ì •
      - name: âš™ï¸ Set Dynamic Variables
        id: set_vars
        run: |
          # 1. íŠ¸ë¦¬ê±° íƒ€ì…ì— ë”°ë¼ ë°°í¬ ëŒ€ìƒ í™˜ê²½ ë° ë¸Œëœì¹˜ë¥¼ ê²°ì •
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ, dev í™˜ê²½ìœ¼ë¡œ ë°°í¬ (ì¼ë°˜ì ì¸ Dev/Staging flow)
            DEPLOY_TARGET_BRANCH="main"
            DEPLOY_ENV="dev"
          else
            # ìˆ˜ë™ dispatch ì‹¤í–‰ ì‹œ, ì‚¬ìš©ì ì…ë ¥ê°’ ì‚¬ìš©
            DEPLOY_TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
            DEPLOY_ENV="${{ github.event.inputs.target_environment }}"
          fi
          
          # 2. ê²°ì •ëœ í™˜ê²½ì— ë”°ë¼ BUCKETê³¼ ROLE ARN ì„¤ì •
          if [[ "$DEPLOY_ENV" == "production" ]]; then
            echo "ENV_BUCKET=${{ env.S3_BUCKET_PRD }}" >> $GITHUB_ENV
            echo "ROLE_ARN=${{ secrets.GITHUB_ACTIONS_PRD_ROLE_ARN }}" >> $GITHUB_ENV # Prod Role ARN
          else
            echo "ENV_BUCKET=${{ env.S3_BUCKET_DEV }}" >> $GITHUB_ENV
            echo "ROLE_ARN=${{ secrets.GITHUB_ACTIONS_DEV_ROLE_ARN }}" >> $GITHUB_ENV # Dev Role ARN
          fi
          
          echo "DEPLOY_BRANCH=$DEPLOY_TARGET_BRANCH" >> $GITHUB_ENV


      # 2. ğŸ“¥ Checkout repository (ë™ì ìœ¼ë¡œ ê²°ì •ëœ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ)
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # ğŸŒŸ ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì‚¬ìš©ìê°€ ì„ íƒí•œ ë¸Œëœì¹˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ë„ë¡ refë¥¼ ì§€ì •
          ref: ${{ env.DEPLOY_BRANCH }} 

      # 3. âš™ï¸ Setup Node
      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 4. ğŸ“¦ Install dependencies
      - name: ğŸ“¦ Install dependencies (npm ci)
        working-directory: frontend
        run: npm ci

      # 5. ğŸ—ï¸ Build frontend
      - name: ğŸ—ï¸ Build frontend (npm run build)
        working-directory: frontend
        run: npm run build

      # 6. ğŸ” Configure AWS credentials (ë™ì  Role ARN ì‚¬ìš©)
      - name: ğŸ” Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # ğŸŒŸ ë™ì ìœ¼ë¡œ ê²°ì •ëœ Role ARN ì‚¬ìš©
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 7. ğŸš€ Deploy to S3 (ë™ì ìœ¼ë¡œ ê²°ì •ëœ ë²„í‚· ì‚¬ìš©)
      - name: ğŸš€ Deploy to S3
        # dist í´ë” ì´ë¦„ì€ í”„ë¡œì íŠ¸ í™˜ê²½ì— ë”°ë¼ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (build, dist ë“±)
        run: aws s3 sync frontend/dist s3://${{ env.ENV_BUCKET }} --delete
