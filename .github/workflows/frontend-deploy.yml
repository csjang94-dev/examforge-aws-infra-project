# .github/workflows/frontend-deploy.yml

name: 'Frontend Deploy to S3'

on:
  workflow_dispatch:
    inputs:
      # ğŸŒŸ 1. ì‚¬ìš©ìì—ê²Œ ë°°í¬í•  ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ë„ë¡ ìš”ì²­
      target_branch:
        description: 'Select the branch to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prd
  push:
    branches:
      - dev
      - prd

jobs:
  deploy-s3:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'prd' && 'production' || 'development' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. AWS ì¸ì¦ (OIDC ì‚¬ìš©)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Secretsì— ì €ì¥ëœ í™˜ê²½ë³„ ARN ì‚¬ìš©
          role-to-assume: ${{ github.ref_name == 'prd' && secrets.PRD_AWS_ROLE_ARN || secrets.DEV_AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 2. (ì„ íƒ) í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ì˜ˆì‹œ: React, Vue, Angular)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # ì‹¤ì œ í”„ë¡œì íŠ¸ ë²„ì „ì— ë§ê²Œ ìˆ˜ì •
          cache: 'npm'
          cache-dependency-path: './examforge/frontend/package-lock.json'

      - name: Install Dependencies and Build
        run: |
          cd ./examforge/frontend # í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ í´ë” ì´ë™
          npm install
          npm run build # build ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ì •ì  íŒŒì¼ì„ ìƒì„±

      # 3. S3ì— íŒŒì¼ ë™ê¸°í™”
      - name: Sync Frontend Files to S3
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ë™ê¸°í™”í•  ë²„í‚· ì´ë¦„ ê²°ì •
          BUCKET_NAME="examforge-frontend-${{ github.ref_name == 'prd' && 'prd' || 'dev' }}"
          
          aws s3 sync ./examforge/frontend/build s3://${BUCKET_NAME} \
            --acl public-read \
            --delete # S3 ë²„í‚·ì— ì—†ëŠ” íŒŒì¼ì€ ì‚­ì œ
